<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Walkthrough: Elasticsearch in Spring &#8212; LaunchCode: GIS DevOps  documentation</title>
    <link rel="stylesheet" href="../../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/launchcode.css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    <script type="text/javascript" src="../../_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="../../_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="../../_static/bootstrap-3.3.7/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../../_static/bootstrap-sphinx.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

  </head><body>

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../../index.html"><span><img src="../../_static/lc-logo.svg" alt="LaunchCode logo"></span>
          GIS DevOps</a>
        <span class="navbar-text navbar-version pull-left"><b></b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../../index.html">Pages <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul>
<li class="toctree-l1"><a class="reference internal" href="../../week01/day1/index.html">Week 1 - Day 1: Git, GitLab, IntelliJ, Refactoring, Unit Testing</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../week01/day1/index.html#summary">Summary</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../week01/day1/index.html#prerequisites">Prerequisites</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../week01/day1/index.html#slides">Slides</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../week01/day1/index.html#walkthrough">Walkthrough</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../week01/day1/index.html#exercises">Exercises</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../week01/day1/index.html#studio">Studio</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../week01/day1/index.html#resources">Resources</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../week01/day2/index.html">Week 1 - Day 2: Security, Test-driven development</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../week01/day2/index.html#lesson-content">Lesson Content</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../week01/day2/index.html#walkthrough">Walkthrough</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../week01/day2/index.html#studio">Studio</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../week01/day2/index.html#resources">Resources</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../week01/day3/index.html">Week 1 - Day 3: Integration testing, dependency injection</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../week01/day3/index.html#lesson-content">Lesson Content</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../week01/day3/index.html#walkthrough">Walkthrough</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../week01/day3/index.html#studio">Studio</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../week01/day4/index.html">Week 1 - Day 4: Postgres, Spring Data, JPA, Hibernate</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../week01/day4/index.html#lesson-content">Lesson Content</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../week01/day4/index.html#walkthroughs">Walkthroughs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../week01/day4/index.html#studio">Studio</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../week01/day5/index.html">Week 1 - Day 5: AJAX, Open Layers</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../week01/day5/index.html#lesson-content">Lesson Content</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../week01/day5/index.html#walkthrough">Walkthrough</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../week01/day5/index.html#studio">Studio</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../week01/day5/index.html#retro">Retro</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../week01/day5/index.html#additional-resources">Additional Resources</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../week02/project/index.html">Week 2 - Project Week: Zika Mission Control</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../week02/project/index.html#project">Project</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../week02/project/index.html#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../week02/project/index.html#requirements">Requirements</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../week02/project/index.html#project-hints">Project Hints</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../week02/project/index.html#setup-project">Setup Project</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../week02/project/index.html#setup-postgres">Setup Postgres</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../week02/project/index.html#turning-in-your-work">Turning In Your Work</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../week02/project/index.html#bonus-missions">Bonus Missions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../week02/project/index.html#resources">Resources</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../week03/day1/index.html">Week 3 - Day 1: RESTful web services</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../week03/day1/index.html#lesson-content">Lesson Content</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../week03/day1/index.html#walkthrough">Walkthrough</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../week03/day1/index.html#studio">Studio</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../week03/day1/index.html#resources">Resources</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../week03/day2/index.html">Week 3 - Day 2 Swagger REST framework</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../week03/day2/index.html#lesson-content">Lesson Content</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../week03/day2/index.html#walkthrough">Walkthrough</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../week03/day2/index.html#studio">Studio</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../week03/day2/index.html#resources">Resources</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../week03/day3/index.html">Week 3 - Day 3: Intro to Elasticsearch</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../week03/day3/index.html#summary">Summary</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../week03/day3/index.html#lesson-content">Lesson Content</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../week03/day3/index.html#walkthrough">Walkthrough</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../week03/day3/index.html#studio">Studio</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../week03/day3/index.html#resources">Resources</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../week03/day4/index.html">Week 3 - Day 4: More Elasticsearch, Integrating ES with Spring</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../week03/day4/index.html#summary">Summary</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../week03/day4/index.html#lesson-content">Lesson Content</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../week03/day4/index.html#studio">Studio</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../week03/day4/index.html#walkthrough">Walkthrough</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../week03/day4/index.html#resources">Resources</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../week03/day5/index.html">Week 3 - Day 5: ES2015, ESLint, OpenLayers</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../week03/day5/index.html#summary">Summary</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../week03/day5/index.html#lesson-content">Lesson Content</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../week03/day5/index.html#walkthrough">Walkthrough</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../week03/day5/index.html#studio">Studio</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../week03/day5/index.html#retro">Retro</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../week03/day5/index.html#resources">Resources</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../week04/project/index.html">Week 4 - Project Week: Zika Mission Control Part 2</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../week04/project/index.html#project">Project</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../week04/project/index.html#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../week04/project/index.html#getting-the-code">Getting the code</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../week04/project/index.html#what-s-new-in-the-code">What’s new in the code</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../week04/project/index.html#requirements">Requirements</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../week04/project/index.html#suggested-endpoints-parameters">Suggested Endpoints/Parameters</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../week04/project/index.html#database-setup">Database Setup</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../week04/project/index.html#walkthrough-on-creating-the-location-data">Walkthrough on Creating the Location Data</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../week05/day1/index.html">Week 5 - Day 1: Intro to DevOps/AWS</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../week05/day1/index.html#lesson-content">Lesson Content</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../week05/day1/index.html#walkthrough">Walkthrough</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../week05/day1/index.html#studio">Studio</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../week05/day2/index.html">Week 5 - Day 2: More with AWS</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../week05/day2/index.html#lesson-content">Lesson Content</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../week05/day2/index.html#studio">Studio</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../week05/day2/index.html#resources">Resources</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../week05/day3/index.html">Week 5 - Day 3: 12 Factor Apps and Auto Scaling</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../week05/day3/index.html#lesson-content">Lesson Content</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../week05/day3/index.html#studio">Studio</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../week05/day4/index.html">Week 5 - Day 4: Gradle, Continuous Integration</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../week05/day4/index.html#lesson-content">Lesson Content</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../week05/day4/index.html#walkthrough">Walkthrough</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../week05/day4/index.html#resources">Resources</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../week05/day5/index.html">Week 5 - Day 5: Sonarqube</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../week05/day5/index.html#lesson-content">Lesson Content</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../week05/day5/index.html#walkthrough">Walkthrough</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../week05/day5/index.html#retro">Retro</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../week06/project/index.html">Week 6 - Project Week: Zika Mission Control Part 3</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../week06/project/index.html#project">Project</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../week06/project/index.html#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../week06/project/index.html#requirements">Requirements</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../week06/project/index.html#new-stuff">New Stuff</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../week06/project/index.html#milestones">Milestones</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../week06/project/index.html#debrief">Debrief</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../week06/project/index.html#bonus-missions">Bonus Missions</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../week08/project/index.html">Week 8 - Project Week: Zika Mission Control Part 4</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../week08/project/index.html#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../week08/project/index.html#requirements">Requirements</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../week08/project/index.html#normalizing-data">Normalizing Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../week08/project/index.html#setup">Setup</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../week08/project/index.html#integrating-geoserver">Integrating GeoServer</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../week09/day3/index.html">Week 9 - Day 3: Intro to Docker</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../week09/day3/index.html#lesson-content">Lesson Content</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../week09/day3/index.html#walkthrough">Walkthrough</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../week09/day3/index.html#studio">Studio</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../week09/day4/index.html">Week 9 - Day 4: OAuth2</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../week09/day4/index.html#lesson">Lesson</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../week09/day4/index.html#resources">Resources</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../week09/day5/index.html">Week 9 - Day 5: Certificates</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../week09/day5/index.html#lesson-content">Lesson Content</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../week09/day5/index.html#walkthrough">Walkthrough</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../week09/day5/index.html#resources">Resources</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../week09/day5/index.html#retro">Retro</a></li>
</ul>
</li>
</ul>
</ul>
</li>
              
            
            
            
            
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
      <div class="col-md-3">
        <div id="sidebar" class="bs-sidenav" role="complementary"><ul>
<li><a class="reference internal" href="#">Walkthrough: Elasticsearch in Spring</a><ul>
<li><a class="reference internal" href="#getting-ready">Getting Ready</a><ul>
<li><a class="reference internal" href="#upgrading-spring-boot">Upgrading Spring Boot</a></li>
<li><a class="reference internal" href="#rename-your-cluster">Rename Your Cluster</a></li>
</ul>
</li>
<li><a class="reference internal" href="#integrating-elasticsearch">Integrating Elasticsearch</a><ul>
<li><a class="reference internal" href="#add-gradle-dependencies">Add Gradle dependencies</a></li>
<li><a class="reference internal" href="#configuring-spring-boot-for-es">Configuring Spring Boot for ES</a></li>
<li><a class="reference internal" href="#write-a-test">Write A Test</a></li>
<li><a class="reference internal" href="#model-and-repository">Model and Repository</a></li>
<li><a class="reference internal" href="#controller">Controller</a></li>
<li><a class="reference internal" href="#elasticsearch-controller">Elasticsearch Controller</a></li>
</ul>
</li>
<li><a class="reference internal" href="#saving-itemdocuments">Saving ItemDocuments</a></li>
<li><a class="reference internal" href="#testing">Testing</a></li>
<li><a class="reference internal" href="#refresh-the-index">Refresh the Index</a></li>
<li><a class="reference internal" href="#your-tasks">Your Tasks</a></li>
<li><a class="reference internal" href="#bonus-missions">Bonus Missions</a></li>
<li><a class="reference internal" href="#resources">Resources</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    <div class="col-md-9 content">
      
  <div class="section" id="walkthrough-elasticsearch-in-spring">
<span id="elasticsearch-spring-walkthrough"></span><h1>Walkthrough: Elasticsearch in Spring<a class="headerlink" href="#walkthrough-elasticsearch-in-spring" title="Permalink to this headline">¶</a></h1>
<p>We’ll walk through the steps to integrate Elasticsearch with Spring, using the Launchcart application.</p>
<p>The goal is to enable fuzzy searching for items via LaunchCart’s REST API. This will require:</p>
<ol class="arabic simple">
<li>Configuring the application to work with Elasticsearch.</li>
<li>Creating a Java representation of the item documents we want to store in Elasticsearch.</li>
<li>Creating a REST endpoint that conducts a fuzzy search for item documents.</li>
</ol>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">This walkthrough was updated in January 2019. If you want to reference the previous version–which includes instructions for integrating with an embedded Elasticsearch instance using Spring Boot 1.x–you will find it here: <a class="reference internal" href="old.html#elasticsearch-spring-walkthrough-old"><span class="std std-ref">Walkthrough: Elasticsearch in Spring</span></a></p>
</div>
<div class="section" id="getting-ready">
<h2>Getting Ready<a class="headerlink" href="#getting-ready" title="Permalink to this headline">¶</a></h2>
<div class="section" id="upgrading-spring-boot">
<h3>Upgrading Spring Boot<a class="headerlink" href="#upgrading-spring-boot" title="Permalink to this headline">¶</a></h3>
<p>This walkthrough assumes that you are using Spring Boot 2.x. You can check the version of Spring Boot that you are using for a given project by referring to the <code class="docutils literal notranslate"><span class="pre">springBootVersion</span></code> property near the top of <code class="docutils literal notranslate"><span class="pre">build.gradle</span></code>.</p>
<p>If you need to update a Spring Boot app from 1.x to 2.x, follow the instructions here: <a class="reference internal" href="../upgrading-spring-boot/index.html#upgrading-spring-boot"><span class="std std-ref">Walkthrough: Upgrading to Spring Boot 2.x</span></a>.</p>
</div>
<div class="section" id="rename-your-cluster">
<h3>Rename Your Cluster<a class="headerlink" href="#rename-your-cluster" title="Permalink to this headline">¶</a></h3>
<p>We can view the name a local Elasticsearch cluster by querying it’s root endpoint, <code class="docutils literal notranslate"><span class="pre">localhost:9200</span></code> (use <code class="docutils literal notranslate"><span class="pre">curl</span> <span class="pre">localhost:9200</span></code> at the command line). If you installed ES via Homebrew on a Mac, your cluster is most likely named <code class="docutils literal notranslate"><span class="pre">elasticsearch_USERNAME</span></code>, where USERNAME is your macOS system user name. Spring Boot will look for a cluster named <code class="docutils literal notranslate"><span class="pre">elasticsearch</span></code> by default, and since it’s easier to change the name of our cluster than it is to customize the Spring Boot configuration, we’ll do that.</p>
<p>Open the ES configuration file, <code class="docutils literal notranslate"><span class="pre">/usr/local/etc/elasticsearch/elasticsearch.yml</span></code>, and change the <code class="docutils literal notranslate"><span class="pre">cluster.name</span></code> property to have the value <code class="docutils literal notranslate"><span class="pre">elasticsearch</span></code>. Save and close the file, then restart your cluster:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ brew services restart elasticsearch
</pre></div>
</div>
</div>
</div>
<div class="section" id="integrating-elasticsearch">
<h2>Integrating Elasticsearch<a class="headerlink" href="#integrating-elasticsearch" title="Permalink to this headline">¶</a></h2>
<p>We will now walk through several steps needed to use Elasticsearch within Spring.</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>The code that we’ll look at is in the <code class="docutils literal notranslate"><span class="pre">elasticsearch-remote-transport</span></code> branch of the <code class="docutils literal notranslate"><span class="pre">LaunchCodeTraining/launchcart</span></code> repository.</p>
<p class="last">To view the specific changes, look at <a class="reference external" href="https://gitlab.com/LaunchCodeTraining/launchcart/commit/62bc976eb25f65bf7fe2d083f370b6b8dfa4d166">this commit</a>.</p>
</div>
<div class="section" id="add-gradle-dependencies">
<h3>Add Gradle dependencies<a class="headerlink" href="#add-gradle-dependencies" title="Permalink to this headline">¶</a></h3>
<p>We need two new dependencies in order to connect ES with Spring Boot.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>compile(&#39;org.springframework.data:spring-data-elasticsearch:3.1.3.RELEASE&#39;)
compile(&#39;net.java.dev.jna:jna&#39;)
</pre></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>This approach uses the <code class="docutils literal notranslate"><span class="pre">TransportClient</span></code> class to connect to a cluster over port 9300 via the transport protocol. This technique requires that the ES instance and the <code class="docutils literal notranslate"><span class="pre">TransportClient</span></code> have the <em>same major versions</em>.</p>
<p class="last">Check your version of Elasticsearch by running <code class="docutils literal notranslate"><span class="pre">curl</span> <span class="pre">localhost:9200</span></code>. The version of Elasticsearch supported by a given version of the <code class="docutils literal notranslate"><span class="pre">spring-data-elasticsearch</span></code> dependency is documented on <a class="reference external" href="https://github.com/spring-projects/spring-data-elasticsearch">that project’s GitHub README</a>.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>The Spring Data project is in the process of replacing the transport client with a REST API client that will be version agnostic.</p>
<p class="last">Read more about the state of the official <a class="reference external" href="https://www.elastic.co/blog/state-of-the-official-elasticsearch-java-clients">Elasticsearch Java clients</a>.</p>
</div>
</div>
<div class="section" id="configuring-spring-boot-for-es">
<h3>Configuring Spring Boot for ES<a class="headerlink" href="#configuring-spring-boot-for-es" title="Permalink to this headline">¶</a></h3>
<p>We need to do two things so that Spring Boot knows how to communicate with our cluster:</p>
<ol class="arabic simple">
<li>Provide the cluster location / URL.</li>
<li>Define the index name(s) that we will use in both test and development contexts.</li>
</ol>
<p>In <code class="docutils literal notranslate"><span class="pre">application.properties</span></code>, add the following properties:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>spring.data.elasticsearch.cluster-nodes=localhost:9300
es.index-name=launchcart
</pre></div>
</div>
<p>In <code class="docutils literal notranslate"><span class="pre">application-test.properties</span></code>, add similar property definitions (note the different index name here):</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>spring.data.elasticsearch.cluster-nodes=localhost:9300
es.index-name=launchcart_test
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">We use port 9300 rather than 9200 because we are configuring Spring to use Elasticsearch’s transport client, and not it’s REST API.</p>
</div>
<p>The first property informs the Spring Data Elasticsearch library of the location of our cluster.</p>
<p>The second property is a custom property that we’ll use within our code. It is <em>not</em> a property supported by Spring Data Elasticsearch. We will have to manually in our code. While we won’t use the property quite yet, we need to do one more thing to make this property more easily referenced within our code.</p>
<p>Create a class, <code class="docutils literal notranslate"><span class="pre">EsConfig</span></code>, at the root of your application and add the following code:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="o">/*</span>
 <span class="o">*</span> <span class="n">In</span> <span class="n">src</span><span class="o">/</span><span class="n">test</span><span class="o">/</span><span class="n">java</span><span class="o">/</span><span class="n">org</span><span class="o">/</span><span class="n">launchcode</span><span class="o">/</span><span class="n">launchcart</span><span class="o">/</span><span class="n">EsConfig</span><span class="o">.</span><span class="na">java</span>
 <span class="o">/*</span>
<span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">EsConfig</span> <span class="o">{</span>

    <span class="nd">@Value</span><span class="o">(</span><span class="s">&quot;${es.index-name}&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">indexName</span><span class="o">;</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getIndexName</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">indexName</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setIndexName</span><span class="o">(</span><span class="n">String</span> <span class="n">indexName</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">indexName</span> <span class="o">=</span> <span class="n">indexName</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">&#64;Value</span></code> annotation tells Spring to read the <code class="docutils literal notranslate"><span class="pre">es.index-name</span></code> property from the properties file and store it in the field <code class="docutils literal notranslate"><span class="pre">indexName</span></code>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">&#64;Component</span></code> annotation tells Spring that this class is a bean that it should create and manage. The end result of setting up this class is that we can use <a class="reference external" href="https://docs.spring.io/spring-framework/docs/3.2.x/spring-framework-reference/html/expressions.html">Spring’s Expression Language</a> to dynamically insert the value of the <code class="docutils literal notranslate"><span class="pre">indexName</span></code> field in our code with the syntax <code class="docutils literal notranslate"><span class="pre">#{esConfig.indexName}</span></code>. We will do this when creating the model class to represent ES documents, but before we do that, let’s practice TDD.</p>
</div>
<div class="section" id="write-a-test">
<h3>Write A Test<a class="headerlink" href="#write-a-test" title="Permalink to this headline">¶</a></h3>
<p>Let’s write an integration test for the desired behavior. Again, the goal of this tutorial is to enable fuzzy searching for items via LaunchCart’s REST API.</p>
<p>We will soon create the classes <code class="docutils literal notranslate"><span class="pre">ItemDocument</span></code> and <code class="docutils literal notranslate"><span class="pre">ItemDocumentController</span></code> to implement fuzzy search, so let’s name our test class <code class="docutils literal notranslate"><span class="pre">ItemDocumentControllerTests</span></code>.</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="o">/*</span>
 <span class="o">*</span> <span class="n">In</span> <span class="n">src</span><span class="o">/</span><span class="n">test</span><span class="o">/</span><span class="n">java</span><span class="o">/</span><span class="n">org</span><span class="o">/</span><span class="n">launchcode</span><span class="o">/</span><span class="n">launchcart</span><span class="o">/</span><span class="n">ItemDocumentControllerTests</span><span class="o">.</span><span class="na">java</span>
 <span class="o">/*</span>
<span class="nd">@RunWith</span><span class="o">(</span><span class="n">SpringRunner</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="nd">@IntegrationTestConfig</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ItemDocumentControllerTests</span> <span class="kd">extends</span> <span class="n">AbstractBaseRestIntegrationTest</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">MockMvc</span> <span class="n">mockMvc</span><span class="o">;</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testFuzzySearch</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">Item</span> <span class="n">item</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Item</span><span class="o">(</span><span class="s">&quot;Test Item Again&quot;</span><span class="o">,</span> <span class="mi">42</span><span class="o">);</span>
        <span class="n">String</span> <span class="n">json</span> <span class="o">=</span> <span class="n">json</span><span class="o">(</span><span class="n">item</span><span class="o">);</span>
        <span class="n">mockMvc</span><span class="o">.</span><span class="na">perform</span><span class="o">(</span><span class="n">post</span><span class="o">(</span><span class="s">&quot;/api/items/&quot;</span><span class="o">)</span>
                <span class="o">.</span><span class="na">content</span><span class="o">(</span><span class="n">json</span><span class="o">)</span>
                <span class="o">.</span><span class="na">contentType</span><span class="o">(</span><span class="n">contentType</span><span class="o">));</span>
        <span class="n">mockMvc</span><span class="o">.</span><span class="na">perform</span><span class="o">(</span><span class="n">get</span><span class="o">(</span><span class="s">&quot;/api/items/search?q={term}&quot;</span><span class="o">,</span> <span class="s">&quot;agan&quot;</span><span class="o">))</span>
                <span class="o">.</span><span class="na">andDo</span><span class="o">(</span><span class="n">print</span><span class="o">())</span>
                <span class="o">.</span><span class="na">andExpect</span><span class="o">(</span><span class="n">status</span><span class="o">().</span><span class="na">isOk</span><span class="o">())</span>
                <span class="o">.</span><span class="na">andExpect</span><span class="o">(</span><span class="n">content</span><span class="o">().</span><span class="na">contentType</span><span class="o">(</span><span class="n">contentType</span><span class="o">))</span>
                <span class="o">.</span><span class="na">andExpect</span><span class="o">(</span><span class="n">jsonPath</span><span class="o">(</span><span class="s">&quot;$.length()&quot;</span><span class="o">).</span><span class="na">value</span><span class="o">(</span><span class="mi">1</span><span class="o">))</span>
                <span class="o">.</span><span class="na">andExpect</span><span class="o">(</span><span class="n">jsonPath</span><span class="o">(</span><span class="s">&quot;$[0].name&quot;</span><span class="o">).</span><span class="na">value</span><span class="o">(</span><span class="n">item</span><span class="o">.</span><span class="na">getName</span><span class="o">()));</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<p>Run this test to make sure that it fails. The failure should look like this:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>java.lang.AssertionError: Status
Expected :200
Actual   :400
</pre></div>
</div>
<p>If your code throws an exception, review the steps above to make sure you have properly configured Spring Boot to talk to ES.</p>
</div>
<div class="section" id="model-and-repository">
<h3>Model and Repository<a class="headerlink" href="#model-and-repository" title="Permalink to this headline">¶</a></h3>
<p>We need to create a new model class to represent the documents that we’ll be storing in ES, along with a corresponding repository.</p>
<p>Create a new package, <code class="docutils literal notranslate"><span class="pre">org.launchcode.launchcart.models.es</span></code>, and add the following class:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="cm">/*</span>
<span class="cm"> * /src/main/java/org/launchcode/launchcart/models/es/ItemDocument.java</span>
<span class="cm"> */</span>
<span class="nd">@Document</span><span class="o">(</span><span class="n">indexName</span> <span class="o">=</span> <span class="s">&quot;#{esConfig.indexName}&quot;</span><span class="o">,</span> <span class="n">type</span> <span class="o">=</span> <span class="s">&quot;items&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ItemDocument</span> <span class="o">{</span>

    <span class="nd">@Id</span>
    <span class="nd">@GeneratedValue</span><span class="o">(</span><span class="n">strategy</span><span class="o">=</span> <span class="n">GenerationType</span><span class="o">.</span><span class="na">AUTO</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">id</span><span class="o">;</span>

    <span class="kd">private</span> <span class="n">Integer</span> <span class="n">itemUid</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">double</span> <span class="n">price</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">newItem</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">description</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">ItemDocument</span><span class="o">()</span> <span class="o">{}</span>

    <span class="kd">public</span> <span class="nf">ItemDocument</span><span class="o">(</span><span class="n">Item</span> <span class="n">item</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">itemUid</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="na">getUid</span><span class="o">();</span>
        <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="na">getName</span><span class="o">();</span>
        <span class="k">this</span><span class="o">.</span><span class="na">price</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="na">getPrice</span><span class="o">();</span>
        <span class="k">this</span><span class="o">.</span><span class="na">newItem</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="na">isNewItem</span><span class="o">();</span>
        <span class="k">this</span><span class="o">.</span><span class="na">description</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="na">getDescription</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="c1">// Getters and setters omitted</span>

<span class="o">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The <code class="docutils literal notranslate"><span class="pre">&#64;Id</span></code> annotation should come from the <code class="docutils literal notranslate"><span class="pre">javax.persistence</span></code> package, so be sure to select the correct import.</p>
</div>
<p>Review the fields and constructors for this class to make sure you understand what it represents. Each <code class="docutils literal notranslate"><span class="pre">ItemDocument</span></code> object will be a “copy” of an <code class="docutils literal notranslate"><span class="pre">Item</span></code> that is suitable for storing in Elasticsearch, and which keeps track of the original item’s ID in the <code class="docutils literal notranslate"><span class="pre">itemUid</span></code> field.</p>
<p>There are two things to note about the <code class="docutils literal notranslate"><span class="pre">ItemDocument</span></code> class that make it different from our other persistent model classes.</p>
<ol class="arabic simple">
<li>The ID field for the class is of type <code class="docutils literal notranslate"><span class="pre">String</span></code> instead of <code class="docutils literal notranslate"><span class="pre">Integer</span></code>. We do this because Elasticsearch uses hash strings as IDs instead of integers.</li>
<li>The <code class="docutils literal notranslate"><span class="pre">&#64;Document</span></code> annotation notifies Spring that this class may be stored in Elasticsearch, using the index and type names provided. Notice the index name, <code class="docutils literal notranslate"><span class="pre">#{esConfig.indexName}</span></code>. This uses Spring’s expression language to dynamically insert the value of the <code class="docutils literal notranslate"><span class="pre">indexName</span></code> property of the <code class="docutils literal notranslate"><span class="pre">EsConfig</span></code> bean that we created earlier. Recall that this property is set using the value of <code class="docutils literal notranslate"><span class="pre">es.index-name</span></code> in the properties file, so it will be different for development and test contexts.</li>
</ol>
<p>Also add a new repository, which extends <code class="docutils literal notranslate"><span class="pre">ElasticsearchRepository</span></code>:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="cm">/*</span>
<span class="cm"> * src/main/java/org/launchcode/launchcart/data/ItemDocumentRepository.java</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">ItemDocumentRepository</span>
    <span class="kd">extends</span> <span class="n">ElasticsearchRepository</span><span class="o">&lt;</span><span class="n">ItemDocument</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="n">Iterable</span><span class="o">&lt;</span><span class="n">ItemDocument</span><span class="o">&gt;</span> <span class="nf">search</span><span class="o">(</span><span class="n">QueryBuilder</span> <span class="n">queryBuilder</span><span class="o">);</span>

<span class="o">}</span>
</pre></div>
</div>
</div>
<div class="section" id="controller">
<h3>Controller<a class="headerlink" href="#controller" title="Permalink to this headline">¶</a></h3>
<p>Create <code class="docutils literal notranslate"><span class="pre">ItemDocumentController</span></code> and implement the <code class="docutils literal notranslate"><span class="pre">search</span></code> method/endpoint.</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="cm">/*</span>
<span class="cm"> * src/main/java/org/launchcode/launchcart/controllers/es/ItemDocumentController.java</span>
<span class="cm"> */</span>
<span class="nd">@RestController</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;/api/items&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ItemDocumentController</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">ItemDocumentRepository</span> <span class="n">itemDocumentRepository</span><span class="o">;</span>

    <span class="nd">@GetMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;search&quot;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">ItemDocument</span><span class="o">&gt;</span> <span class="nf">search</span><span class="o">(</span><span class="nd">@RequestParam</span> <span class="n">String</span> <span class="n">q</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">FuzzyQueryBuilder</span> <span class="n">fuzzyQueryBuilder</span> <span class="o">=</span> <span class="n">QueryBuilders</span><span class="o">.</span><span class="na">fuzzyQuery</span><span class="o">(</span><span class="s">&quot;name&quot;</span><span class="o">,</span> <span class="n">q</span><span class="o">);</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">ItemDocument</span><span class="o">&gt;</span> <span class="n">results</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
        <span class="n">Iterator</span><span class="o">&lt;</span><span class="n">ItemDocument</span><span class="o">&gt;</span> <span class="n">iterator</span> <span class="o">=</span> <span class="n">itemDocumentRepository</span><span class="o">.</span><span class="na">search</span><span class="o">(</span><span class="n">fuzzyQueryBuilder</span><span class="o">).</span><span class="na">iterator</span><span class="o">();</span>

        <span class="k">while</span><span class="o">(</span><span class="n">iterator</span><span class="o">.</span><span class="na">hasNext</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">results</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">iterator</span><span class="o">.</span><span class="na">next</span><span class="o">());</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="n">results</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<p>Spring is unable to serialize (i.e. turn into XML or JSON) an <code class="docutils literal notranslate"><span class="pre">Iterable</span></code> object, so we must copy each of the results into a new <code class="docutils literal notranslate"><span class="pre">List</span></code>. If we expect large results sets, we should use a paginated approach that only returns segments of the result set.</p>
</div>
<div class="section" id="elasticsearch-controller">
<h3>Elasticsearch Controller<a class="headerlink" href="#elasticsearch-controller" title="Permalink to this headline">¶</a></h3>
<p>Create <code class="docutils literal notranslate"><span class="pre">EsController</span></code> and <code class="docutils literal notranslate"><span class="pre">EsUtils</span></code> to enable admin-oriented interactions with the ES instance.</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="cm">/*</span>
<span class="cm"> * src/main/java/org/launchcode/launchcart/controllers/es/EsController.java</span>
<span class="cm"> */</span>
<span class="nd">@RestController</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;/api/es&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">EsController</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">EsUtil</span> <span class="n">esUtil</span><span class="o">;</span>

    <span class="nd">@PostMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;/refresh&quot;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">ResponseEntity</span> <span class="nf">refresh</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">esUtil</span><span class="o">.</span><span class="na">refresh</span><span class="o">();</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">ResponseEntity</span><span class="o">(</span><span class="s">&quot;Refreshed Elasticsearch index\n&quot;</span><span class="o">,</span> <span class="n">HttpStatus</span><span class="o">.</span><span class="na">OK</span><span class="o">);</span>

    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="cm">/*</span>
<span class="cm"> * src/main/java/org/launchcode/launchcart/util/EsUtil.java</span>
<span class="cm"> */</span>
<span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">EsUtil</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">ItemRepository</span> <span class="n">itemRepository</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">ItemDocumentRepository</span> <span class="n">itemDocumentRepository</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">refresh</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">itemDocumentRepository</span><span class="o">.</span><span class="na">deleteAll</span><span class="o">();</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">ItemDocument</span><span class="o">&gt;</span> <span class="n">itemDocuments</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
        <span class="k">for</span><span class="o">(</span><span class="n">Item</span> <span class="n">item</span> <span class="o">:</span> <span class="n">itemRepository</span><span class="o">.</span><span class="na">findAll</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">itemDocuments</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">ItemDocument</span><span class="o">(</span><span class="n">item</span><span class="o">));</span>
        <span class="o">}</span>
        <span class="n">itemDocumentRepository</span><span class="o">.</span><span class="na">saveAll</span><span class="o">(</span><span class="n">itemDocuments</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="saving-itemdocuments">
<h2>Saving ItemDocuments<a class="headerlink" href="#saving-itemdocuments" title="Permalink to this headline">¶</a></h2>
<p>While we have code in place to carry out searches in Elasticsearch via our API, there are not any documents in the ES index quite yet.</p>
<p>Within <code class="docutils literal notranslate"><span class="pre">ItemController</span></code> and <code class="docutils literal notranslate"><span class="pre">ItemRestController</span></code>, let’s save a new <code class="docutils literal notranslate"><span class="pre">ItemDocument</span></code> every time we create a new <code class="docutils literal notranslate"><span class="pre">Item</span></code>.</p>
<p>We previously saved and returned a new <code class="docutils literal notranslate"><span class="pre">Item</span></code> like this:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">itemRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">item</span><span class="o">);</span>
</pre></div>
</div>
<p>Now, however, we must also save an <code class="docutils literal notranslate"><span class="pre">ItemDocument</span></code> for each newly-created item:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">Item</span> <span class="n">savedItem</span> <span class="o">=</span> <span class="n">itemRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">item</span><span class="o">);</span>
<span class="n">itemDocumentRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="k">new</span> <span class="n">ItemDocument</span><span class="o">(</span><span class="n">savedItem</span><span class="o">));</span>
</pre></div>
</div>
<p>You will need to add an <code class="docutils literal notranslate"><span class="pre">&#64;Autowire</span></code>’d <code class="docutils literal notranslate"><span class="pre">ItemDocumentRepository</span></code> to each controller in which this change is made.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">We should also update or delete an <code class="docutils literal notranslate"><span class="pre">ItemDocument</span></code> whenever the corresponding <code class="docutils literal notranslate"><span class="pre">Item</span></code> is updated or deleted. We leave this exercise to you.</p>
</div>
</div>
<div class="section" id="testing">
<h2>Testing<a class="headerlink" href="#testing" title="Permalink to this headline">¶</a></h2>
<p>Run all tests for your application. Hopefully, everything will pass. If not, review the test report and correct any issues.</p>
<p>Even if all of your tests all pass the first time, the new <code class="docutils literal notranslate"><span class="pre">ItemDocumentControllerTests.testFuzzySearch</span></code> test will fail the second time it is run. This is because the number of search results will be incorrect, since we failed to clear our Elasticsearch index after the first run. Unlike our in-memory relational test database, Elasticsearch will keep data from one test run to another.</p>
<p>We want to ensure that any documents created during testing are removed after each individual test has run.</p>
<p>Create a new base class, <code class="docutils literal notranslate"><span class="pre">AbstractBaseIntegrationTest</span></code>:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AbstractBaseIntegrationTest</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">ItemDocumentRepository</span> <span class="n">itemDocumentRepository</span><span class="o">;</span>

    <span class="nd">@After</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">clearItemDocumentRepository</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">itemDocumentRepository</span><span class="o">.</span><span class="na">deleteAll</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>Then modify both <code class="docutils literal notranslate"><span class="pre">AbstractBaseRestIntegrationTest</span></code> and <code class="docutils literal notranslate"><span class="pre">AbstractBaseCustomerIntegrationTest</span></code> to extend this new base class. This will ensure that Elasticsearch data created by each test is deleted when the test has completed.</p>
</div>
<div class="section" id="refresh-the-index">
<h2>Refresh the Index<a class="headerlink" href="#refresh-the-index" title="Permalink to this headline">¶</a></h2>
<p>While your tests are now passing, if you were to start up your application and try to conduct a fuzzy search (e.g. <code class="docutils literal notranslate"><span class="pre">curl</span> <span class="pre">localhost:8080/api/items/search?q=shoe</span></code>) you would not receive any hits. If the reason why isn’t obvious, it should become so after looking at the data in your <code class="docutils literal notranslate"><span class="pre">launchcart</span></code> index in Elasticsearch.</p>
<p>Since each of the items in our Postgres database was created <em>before</em> we added the Elasticsearch integration, the associate <code class="docutils literal notranslate"><span class="pre">ItemDocument</span></code> objects were not created. We can retroactively create the objects and docuemnts using our special endpoint for refreshing the index. Start up your application, and make a request to this endpoint:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ curl -XPOST localhost:8080/api/es/refresh/
</pre></div>
</div>
<p>You should now see the exact number of documents in the <code class="docutils literal notranslate"><span class="pre">launchcart</span></code> Elasticsearch index as there are rows in the <code class="docutils literal notranslate"><span class="pre">items</span></code> table in Postgres.</p>
</div>
<div class="section" id="your-tasks">
<h2>Your Tasks<a class="headerlink" href="#your-tasks" title="Permalink to this headline">¶</a></h2>
<p>On your own, study the code above and make sure you understand each of the components, referring to the linked resources below as necessary. When you come across something that isn’t clear, talk through it with another student or with an instrutor.</p>
</div>
<div class="section" id="bonus-missions">
<h2>Bonus Missions<a class="headerlink" href="#bonus-missions" title="Permalink to this headline">¶</a></h2>
<p>We looked at how to push a new item to Elasticsearch when creating it via the REST API. There are still several tasks that can be immediately carried out to fully integrate ES with the application. Try one more more of the following:</p>
<ul class="simple">
<li>We are currently creating and saving a new <code class="docutils literal notranslate"><span class="pre">ItemDocument</span></code> whenever a new <code class="docutils literal notranslate"><span class="pre">Item</span></code> is created, however, we are not updating or deleting an <code class="docutils literal notranslate"><span class="pre">ItemDocument</span></code> when the corresponding <code class="docutils literal notranslate"><span class="pre">Item</span></code> is updated or deleted. Add the code to do this.</li>
<li>Add a search view that displays results of a fuzzy search. This may be done either via an AJAX request to <code class="docutils literal notranslate"><span class="pre">ItemDocumentRepository.search</span></code>, or by creating a new controller method that passes fuzzy search results into a template.</li>
</ul>
</div>
<div class="section" id="resources">
<h2>Resources<a class="headerlink" href="#resources" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><a class="reference external" href="http://www.baeldung.com/spring-data-elasticsearch-tutorial">Spring Data Elasticsearch</a></li>
<li><a class="reference external" href="https://docs.spring.io/spring-data/elasticsearch/docs/current/api/org/springframework/data/elasticsearch/repository/ElasticsearchRepository.html">ElasticsearchRepository</a></li>
<li><a class="reference external" href="https://www.elastic.co/guide/en/elasticsearch/client/java-api/6.2/transport-client.html">TransportClient</a></li>
<li><a class="reference external" href="https://static.javadoc.io/org.elasticsearch/elasticsearch/2.4.0/org/elasticsearch/index/query/QueryBuilders.html">QueryBuilders</a></li>
<li><a class="reference external" href="http://www.baeldung.com/spring-data-elasticsearch-queries">Spring Data Elasticsearch Queries</a></li>
<li><a class="reference external" href="http://www.baeldung.com/spring-value-annotation">The &#64;Value annotation</a></li>
</ul>
</div>
</div>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
        <br/>
        
<div id="sourcelink">
  <a href="../../_sources/walkthroughs/elasticsearch-spring/index.rst.txt"
     rel="nofollow">Page Source</a>
</div>
      
    </p>
    <p>
    </p>
  </div>
</footer>
  </body>
</html>